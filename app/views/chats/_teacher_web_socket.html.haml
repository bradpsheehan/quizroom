= content_for :extra_scripts do
  = javascript_include_tag "http://localhost:9292/faye.js"
  = javascript_include_tag "socket"

  :javascript
    $(document).ready( function() {
      $("section.question").hide();

      var socket = Socket('http://localhost:9292/faye');
      var publicChannel = $('#chat').data("public-channel");
      var publishChannel = $("#publish_channel").val();

      socket.subscribe("/#{@chat.public_channel}", function(data) {
        var question = '';

        if(data.isQuestion) {
          $("section.question").show();
          question = data.question;

          $("h2#question-title").text(question.question);

          var answersLength = data.answers.length;
          var answerList = $("ul#possible-answers");
          answerList.children().remove();

          for(var i = 0; i < answersLength; i++) {
            var currentAnswer = data.answers[i];

            if(currentAnswer.correctAnswer){
              answerList.append("<li class='correct_answer'>"+ currentAnswer.answer+"</li>");
            } else {
              answerList.append("<li>"+currentAnswer.answer+"</li>");
            }
          }

          if(question.nextQuestion){
            $('#next-question').attr('href', question.nextQuestion);
          } else {
            $('#next-question').remove();
          }

        } else {
          $('.no-answer').remove();
          $("#chat").append("<li>"+data.sender+": "+data.answer.text+"</li>");
        }
      });

      $('#next-question').on('click', function() {

        socket.publish("/#{@chat.public_channel}", {
          question: $("#message").val(),
          isQuestion: true,
          sender: "Question"
        });

        $("form")[0].reset();
        return false;

      });

      $('#start-question').on('click', function() {
        //get the first question
        $.get("#{quiz_question_path(@quiz, @quiz.questions.first)}", function(data) {
          console.log(data);
          data.isQuestion = true;
          socket.publish("/#{@chat.public_channel}",data);
        });

        $(this).remove();

        return false;
      });
    });

